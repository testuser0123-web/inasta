generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int            @id @default(autoincrement())
  username               String         @unique
  password               String
  createdAt              DateTime       @default(now())
  avatarUrl              String?
  isVerified             Boolean        @default(false)
  verificationToken      String?
  updatedAt              DateTime       @default(now()) @updatedAt
  bio                    String?
  oshi                   String?
  excludeUnverifiedPosts Boolean        @default(false)
  isGold                 Boolean        @default(false)
  roles                  String[]       @default([])
  comments               Comment[]
  createdContests        Contest[]
  contestLikes           ContestLike[]
  contestPosts           ContestPost[]
  diaries                Diary[]
  diaryComments          DiaryComment[]
  diaryLikes             DiaryLike[]
  following              Follow[]       @relation("following")
  followers              Follow[]       @relation("followers")
  likes                  Like[]
  mutedBy                Mute[]         @relation("mutedBy")
  muted                  Mute[]         @relation("muted")
  posts                  Post[]
}

model Post {
  id           Int         @id @default(autoincrement())
  imageUrl     String
  comment      String?
  createdAt    DateTime    @default(now())
  userId       Int
  isSpoiler    Boolean     @default(false)
  mediaType    MediaType   @default(IMAGE)
  thumbnailUrl String?
  comments     Comment[]
  likes        Like[]
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  images       PostImage[]
  hashtags     Hashtag[]   @relation("HashtagToPost")

  @@index([userId])
}

model PostImage {
  id     Int    @id @default(autoincrement())
  url    String
  order  Int
  postId Int
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Hashtag {
  id    Int    @id @default(autoincrement())
  name  String @unique
  posts Post[] @relation("HashtagToPost")
}

model Like {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    Int
  postId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  userId    Int
  postId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())
  follower    User     @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId])
}

model Mute {
  id        Int      @id @default(autoincrement())
  muterId   Int
  mutedId   Int
  createdAt DateTime @default(now())
  muted     User     @relation("mutedBy", fields: [mutedId], references: [id], onDelete: Cascade)
  muter     User     @relation("muted", fields: [muterId], references: [id], onDelete: Cascade)

  @@unique([muterId, mutedId])
}

model Contest {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  creatorId   Int
  createdAt   DateTime      @default(now())
  creator     User          @relation(fields: [creatorId], references: [id])
  posts       ContestPost[]
}

model ContestPost {
  id        Int                @id @default(autoincrement())
  imageUrl  String
  comment   String?
  userId    Int
  contestId Int
  createdAt DateTime           @default(now())
  likes     ContestLike[]
  contest   Contest            @relation(fields: [contestId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  images    ContestPostImage[]

  @@index([contestId, createdAt])
}

model ContestPostImage {
  id            Int         @id @default(autoincrement())
  url           String
  order         Int
  contestPostId Int
  contestPost   ContestPost @relation(fields: [contestPostId], references: [id], onDelete: Cascade)
}

model ContestLike {
  id            Int         @id @default(autoincrement())
  userId        Int
  contestPostId Int
  createdAt     DateTime    @default(now())
  contestPost   ContestPost @relation(fields: [contestPostId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contestPostId])
}

model Diary {
  id           Int            @id @default(autoincrement())
  title        String
  content      Json
  thumbnailUrl String?
  date         DateTime
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  userId       Int
  isDraft      Boolean        @default(false)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments     DiaryComment[]
  likes        DiaryLike[]

  @@unique([userId, date])
  @@index([date])
}

model DiaryLike {
  id        Int      @id @default(autoincrement())
  userId    Int
  diaryId   Int
  createdAt DateTime @default(now())
  diary     Diary    @relation(fields: [diaryId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, diaryId])
}

model DiaryComment {
  id        Int      @id @default(autoincrement())
  text      String
  userId    Int
  diaryId   Int
  createdAt DateTime @default(now())
  diary     Diary    @relation(fields: [diaryId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum MediaType {
  IMAGE
  VIDEO
}
